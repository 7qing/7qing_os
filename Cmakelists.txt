cmake_minimum_required(VERSION 3.8)

project(7qing_os VERSION 1.0
                  DESCRIPTION "my_first_system_kernel"
                  LANGUAGES C CXX ASM ASM_NASM)

# 设置输出目录
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# 添加子目录 src 
add_subdirectory(src)
# 定义 NASM 汇编文件路径
set(NASM_FILE src/boot/boot.asm)

# 定义 NASM 输出文件
set(BIN_OUTPUT ${CMAKE_BINARY_DIR}/boot.bin)
set(LST_OUTPUT ${CMAKE_BINARY_DIR}/boot.lst)

# 自定义命令生成 NASM 文件
add_custom_command(
    OUTPUT ${BIN_OUTPUT} ${LST_OUTPUT}
    COMMAND nasm -f bin -o ${BIN_OUTPUT} -l ${LST_OUTPUT} ${CMAKE_SOURCE_DIR}/${NASM_FILE}
    COMMENT "Compiling ${NASM_FILE} with NASM"
    DEPENDS ${NASM_FILE}
)

# 定义目标以确保 NASM 文件生成
add_custom_target(nasm_target DEPENDS ${BIN_OUTPUT} ${LST_OUTPUT})

# 生成内核 ISO 文件的目标（示例）
# add_custom_target(kernel_iso ALL
#     COMMAND cp ${BIN_OUTPUT} ${CMAKE_BINARY_DIR}/kernel.iso
#     COMMENT "Copying bootloader to kernel.iso"
# )

# 定义依赖关系
# add_dependencies(kernel_iso nasm_target)
